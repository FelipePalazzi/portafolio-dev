---
import Titles from "../common/Titles.astro";
import SocialIcons from "./SocialIcons.astro";
import { useTranslations } from "../i18n/utils";

const { lang } = Astro.props;
const t = useTranslations(lang);
---

<Titles title={t("contact.title")} idLink="contact" />

<section
    class="flex flex-col md:flex-row gap-10 md:gap-20 justify-center items-stretch w-full max-w-6xl mx-auto px-4 pb-20"
>
    <!-- Left Side: Info & Socials -->
    <div
        class="flex flex-col gap-6 w-full md:w-1/2 relative overflow-hidden p-8 rounded-3xl
    border-2 border-white/10 bg-primary-100/50 shadow-lg shadow-primary-500/40
    backdrop-blur-md hover:border-white/40 hover:bg-primary-300/50
    transition-all duration-300 group"
    >
        <!-- Decorative Blob -->
        <div
            class="absolute -left-6 -bottom-6 w-28 h-28 rounded-full bg-primary-500 opacity-40 blur-3xl group-hover:opacity-60 transition-opacity pointer-events-none"
        >
        </div>

        <div class="space-y-4 relative z-10">
            <p class="text-2xl text-primary-600 leading-relaxed">
                {t("contact.text")}
            </p>
            <div class="flex items-center gap-2 text-primary-800 font-medium">
                <button
                    id="copy-email-btn"
                    class="hover:text-primary-500 transition-all relative group flex items-center gap-2 cursor-pointer"
                    aria-label={t("contact.copy")}
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-mail hover:text-primary-500"
                    >
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"
                        ></path>
                        <path
                            d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"
                        ></path>
                        <path d="M3 7l9 6l9 -6"></path>
                    </svg>
                    <span id="email-text">palazzifelipe@gmail.com</span>
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="opacity-0 group-hover:opacity-100 transition-opacity"
                    >
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"
                        ></path>
                        <path
                            d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"
                        ></path>
                        <path
                            d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"
                        ></path>
                    </svg>
                    <span
                        id="copy-tooltip"
                        class="absolute -top-8 left-1/2 -translate-x-1/2 bg-primary-800 text-white text-xs py-1 px-2 rounded opacity-0 transition-opacity pointer-events-none whitespace-nowrap"
                    >
                        {t("contact.copy")}
                    </span>
                </button>
            </div>
        </div>

        <div class="pt-4 relative z-10">
            <h4 class="text-xl font-semibold text-primary-800 mb-4">
                {t("contact.socials")}
            </h4>
            <div class="flex justify-start">
                <SocialIcons />
            </div>
        </div>
    </div>

    <!-- Right Side: Contact Form -->
    <div
        class="relative w-full md:w-1/2 overflow-hidden p-8 rounded-3xl
        border-2 border-white/10 bg-primary-100/50 shadow-lg shadow-primary-500/40
        backdrop-blur-md hover:border-white/40 hover:bg-primary-300/50
        transition-all duration-300 group"
    >
        <!-- Decorative Blob -->
        <div
            class="absolute -right-6 -top-6 w-28 h-28 rounded-full bg-primary-500 opacity-40 blur-3xl group-hover:opacity-60 transition-opacity pointer-events-none"
        >
        </div>

        <!-- Success Message (Hidden by default) -->
        <div
            id="success-message"
            class="hidden flex-col items-center justify-center h-full min-h-[400px] text-center space-y-4 animate-fade-in"
        >
            <div
                class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-8 w-8"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-primary-800">
                {t("contact.success.title")}
            </h3>
            <p class="text-primary-700">
                {t("contact.success.text")}
            </p>
            <button
                id="reset-form"
                class="mt-6 px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
            >
                {t("contact.success.reset")}
            </button>
        </div>

        <!-- Form -->
        <form
            id="contact-form"
            action="https://formsubmit.co/ajax/palazzifelipe@gmail.com"
            method="POST"
            class="flex flex-col gap-6 relative z-10"
        >
            <!-- Honeypot to prevent spam -->
            <input type="text" name="_honey" style="display:none" />
            <!-- ReCAPTCHA enabled by removing _captcha=false -->

            <div class="flex flex-col gap-2">
                <label
                    for="name"
                    class="text-sm font-medium text-primary-900 group-hover:text-primary-800 transition-colors"
                    >{t("contact.form.name")}</label
                >
                <input
                    type="text"
                    id="name"
                    name="name"
                    placeholder={t("contact.form.namePlaceholder")}
                    class="w-full px-4 py-3 rounded-xl bg-white/60 border border-white/20 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all placeholder:text-primary-400/70 text-primary-900"
                    required
                />
            </div>

            <div class="flex flex-col gap-2">
                <label
                    for="email"
                    class="text-sm font-medium text-primary-900 group-hover:text-primary-800 transition-colors"
                    >{t("contact.form.email")}</label
                >
                <input
                    type="email"
                    id="email"
                    name="email"
                    placeholder={t("contact.form.emailPlaceholder")}
                    class="w-full px-4 py-3 rounded-xl bg-white/60 border border-white/20 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all placeholder:text-primary-400/70 text-primary-900"
                    required
                />
            </div>

            <div class="flex flex-col gap-2">
                <label
                    for="message"
                    class="text-sm font-medium text-primary-900 group-hover:text-primary-800 transition-colors"
                    >{t("contact.form.message")}</label
                >
                <textarea
                    id="message"
                    name="message"
                    rows="4"
                    placeholder={t("contact.form.messagePlaceholder")}
                    class="w-full px-4 py-3 rounded-xl bg-white/60 border border-white/20 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all resize-none placeholder:text-primary-400/70 text-primary-900"
                    required></textarea>
            </div>

            <button
                type="submit"
                id="submit-btn"
                class="w-full py-3 px-6 bg-primary-600 hover:bg-primary-500 text-white font-semibold rounded-xl shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <span>{t("contact.form.send")}</span>
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="icon icon-tabler icons-tabler-outline icon-tabler-send"
                >
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M10 14l11 -11"></path>
                    <path
                        d="M21 3l-6.5 18a0.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a0.55 .55 0 0 1 0 -1l18 -6.5"
                    ></path>
                </svg>
            </button>
        </form>
    </div>
</section>

<script
    define:vars={{
        sendingText: t("contact.form.sending"),
        copyText: t("contact.copy"),
        copiedText: t("contact.copied"),
    }}
>
    const form = document.getElementById("contact-form");
    const successMessage = document.getElementById("success-message");
    const resetBtn = document.getElementById("reset-form");
    const submitBtn = document.getElementById("submit-btn");
    const btnText = submitBtn?.querySelector("span");

    if (form && successMessage && submitBtn && btnText) {
        // Check for cooldown on load
        const lastSent = localStorage.getItem("lastEmailSent");
        if (lastSent) {
            const timeSince = Date.now() - parseInt(lastSent);
            // 5 minutes cooldown visual check (optional, logic is in submit)
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Spam check: Cooldown
            const lastSent = localStorage.getItem("lastEmailSent");
            if (lastSent) {
                const timeSince = Date.now() - parseInt(lastSent);
                if (timeSince < 60 * 1000) {
                    // 1 minute cooldown
                    alert(
                        "Por favor espera un minuto antes de enviar otro mensaje.",
                    );
                    return;
                }
            }

            // Loading state
            const originalText = btnText.innerText;
            btnText.innerText = sendingText;
            submitBtn.disabled = true;

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: {
                        Accept: "application/json",
                    },
                });

                if (response.ok) {
                    // Success state
                    form.style.display = "none";
                    successMessage.classList.remove("hidden");
                    successMessage.classList.add("flex");
                    form.reset();

                    // Set cooldown
                    localStorage.setItem(
                        "lastEmailSent",
                        Date.now().toString(),
                    );
                } else {
                    throw new Error("Error al enviar el formulario");
                }
            } catch (error) {
                console.error(error);
                alert(
                    "Hubo un error al enviar el mensaje. Por favor, intenta nuevamente o contÃ¡ctame directamente por email.",
                );
            } finally {
                // Reset button state
                btnText.innerText = originalText;
                submitBtn.disabled = false;
            }
        });

        resetBtn?.addEventListener("click", () => {
            successMessage.classList.add("hidden");
            successMessage.classList.remove("flex");
            form.style.display = "flex";
        });
    }
    const copyBtn = document.getElementById("copy-email-btn");
    const emailText = document.getElementById("email-text");
    const tooltip = document.getElementById("copy-tooltip");

    if (copyBtn && emailText && tooltip) {
        copyBtn.addEventListener("click", () => {
            const email = emailText.innerText;
            navigator.clipboard.writeText(email).then(() => {
                // Show copied feedback
                tooltip.innerText = copiedText;
                tooltip.classList.remove("opacity-0");
                tooltip.classList.add("opacity-100");

                setTimeout(() => {
                    tooltip.classList.remove("opacity-100");
                    tooltip.classList.add("opacity-0");
                    setTimeout(() => {
                        tooltip.innerText = copyText;
                    }, 300);
                }, 2000);
            });
        });
    }
</script>
